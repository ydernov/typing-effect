name: Release workflow
run-name: Release workflow for ${{ github.ref_name }}

on:
  release:
    types: [published]

jobs:
  set_version_to_tag:
    uses: ./.github/workflows/set-version-to-tag.yml
    with:
      ref: ${{github.ref}}
      ref_name: ${{github.ref_name}}

  point_tag_to_new_commit:
    needs: set_version_to_tag
    uses: ./.github/workflows/point-tag-to-new-commit.yml
    with:
      tag_name: ${{github.ref_name}}
      commit_sha: ${{needs.set_version_to_tag.outputs.merge_commit_sha}}
    secrets:
      ref_pat: ${{ secrets.REF_UPDATE_PAT }}

  create-and-publish-coverage:
    needs: set_version_to_tag
    uses: ./.github/workflows/coverage-and-badge.yml
    with:
      ref: ${{github.ref}}
    
  publish-to-github-packages:
    needs: point_tag_to_new_commit
    uses: ./.github/workflows/publish-to-github-packages.yml
    with:
      ref: ${{github.ref}}

  publish-to-npm:
    needs: point_tag_to_new_commit
    uses: ./.github/workflows/publish-to-npm.yml
    with:
      ref: ${{github.ref}}
    secrets:
      npm_token: ${{ secrets.NPM_TOKEN }}
